/*
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 3.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

#include "BootReloader.h"

 // MULTI-Module STM32F103 Bootloader
const uint16_t bootloaderData[8192] = { 0,80,0,32,241,0,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,57,1,0,8,57,1,0,8,0,0,0,0,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,193,4,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,57,1,0,8,95,248,8,241,0,33,0,240,4,184,11,75,91,88,67,80,4,49,10,72,10,75,66,24,154,66,255,244,246,175,9,74,0,240,3,184,0,35,66,248,4,59,7,75,154,66,255,244,249,175,0,240,41,250,112,71,40,29,0,8,0,0,0,32,200,2,0,32,200,2,0,32,24,5,0,32,255,247,254,191,112,71,112,71,112,71,3,40,140,191,2,32,0,32,112,71,112,71,0,0,3,75,27,104,155,122,19,177,2,75,5,34,26,96,112,71,16,5,0,32,28,5,0,32,112,71,112,71,112,71,112,71,112,71,112,71,1,75,4,34,26,96,112,71,28,5,0,32,16,181,0,240,57,252,33,75,33,74,27,104,0,36,18,104,156,114,210,121,32,70,90,114,30,74,31,75,20,96,25,104,33,244,236,65,33,240,112,1,65,244,0,113,137,178,25,96,25,104,33,244,224,65,33,240,64,1,137,178,129,240,16,1,25,96,17,104,21,75,137,178,11,68,91,0,64,33,25,96,19,104,128,34,155,178,3,241,0,83,3,245,64,83,91,0,26,96,1,240,47,248,14,75,32,70,27,104,147,248,48,16,1,240,128,248,32,70,1,240,22,248,10,75,1,34,32,70,189,232,16,64,26,96,1,240,23,189,0,191,16,5,0,32,184,2,0,32,80,92,0,64,0,92,0,64,4,48,0,32,232,4,0,32,28,5,0,32,56,181,18,75,5,70,26,104,28,70,18,120,2,240,127,2,33,42,25,209,0,240,106,252,176,177,104,30,4,40,19,216,223,232,0,240,3,5,7,18,9,0,9,75,4,224,9,75,2,224,9,75,0,224,9,75,34,104,0,36,32,70,147,97,84,130,152,71,32,70,56,189,2,32,56,189,16,5,0,32,109,10,0,8,149,10,0,8,85,10,0,8,61,10,0,8,1,73,1,240,213,186,0,191,68,1,0,32,1,73,1,240,207,186,0,191,184,2,0,32,5,75,27,104,155,120,7,43,4,216,4,73,1,235,195,1,1,240,194,186,0,32,112,71,16,5,0,32,148,0,0,32,1,73,1,240,185,186,0,191,224,0,0,32,8,181,8,75,27,104,27,120,3,240,127,3,33,43,6,209,0,240,26,252,0,40,12,191,2,32,0,32,8,189,2,32,8,189,0,191,16,5,0,32,55,181,25,76,12,32,37,104,0,240,48,251,40,64,64,244,128,53,37,96,21,72,12,33,0,34,0,240,147,249,0,35,1,147,1,155,179,245,0,127,2,210,1,155,1,51,247,231,12,32,37,104,0,240,26,251,40,64,64,244,128,37,37,96,0,240,38,251,10,75,194,178,24,96,10,75,192,243,7,32,131,248,41,32,131,248,42,0,7,75,90,113,152,113,1,240,153,248,3,176,48,189,0,191,4,8,1,64,0,8,1,64,200,2,0,32,236,0,0,32,41,1,0,32,4,75,26,104,146,178,66,240,12,2,26,96,2,75,3,34,26,96,112,71,64,92,0,64,28,5,0,32,4,75,79,246,251,114,25,104,10,64,26,96,79,244,63,66,26,96,112,71,64,92,0,64,16,181,30,76,7,40,24,191,32,112,35,120,5,43,50,216,223,232,3,240,3,6,10,14,22,33,255,247,229,255,42,224,255,247,226,255,4,35,39,224,2,35,99,112,3,35,35,224,99,120,1,59,219,178,99,112,99,120,243,185,4,34,23,224,15,75,26,104,146,178,66,240,16,2,26,96,5,35,35,112,10,35,99,112,16,189,99,120,1,59,219,178,99,112,99,120,91,185,7,74,79,246,239,115,17,104,11,64,19,96,6,34,2,75,26,112,16,189,6,35,35,112,16,189,206,2,0,32,64,92,0,64,6,75,1,34,26,96,6,74,0,32,6,73,24,96,16,96,79,244,224,82,10,128,26,96,112,71,0,191,64,92,0,64,68,92,0,64,20,5,0,32,4,75,1,34,26,96,4,74,0,32,16,96,3,34,26,96,112,71,0,191,64,92,0,64,68,92,0,64,255,247,240,191,20,32,0,240,211,185,0,0,16,181,0,240,143,250,9,75,0,36,27,104,156,114,255,247,207,255,7,75,7,74,28,96,79,244,63,67,19,128,6,74,19,96,255,247,233,255,5,75,28,96,16,189,16,5,0,32,68,92,0,64,20,5,0,32,64,92,0,64,28,5,0,32,20,32,0,240,187,185,0,0,112,181,39,77,39,76,43,104,39,78,155,178,35,128,34,136,51,136,19,64,89,5,5,213,79,246,255,51,43,96,35,75,91,104,152,71,34,136,51,136,26,64,146,4,68,191,77,246,255,114,42,96,34,136,19,64,219,4,5,213,78,246,255,115,43,96,0,32,255,247,78,255,34,136,51,136,19,64,24,5,4,213,255,247,45,255,79,242,255,115,43,96,34,136,51,136,26,64,145,5,7,213,79,246,255,82,42,96,16,74,17,120,1,49,201,178,17,112,34,136,19,64,218,5,5,213,79,246,255,99,43,96,7,32,255,247,45,255,34,136,51,136,19,64,27,4,3,213,189,232,112,64,0,240,236,190,112,189,0,191,68,92,0,64,204,2,0,32,20,5,0,32,0,0,0,32,24,5,0,32,55,181,0,240,147,248,0,240,181,248,0,240,227,248,255,247,183,254,0,240,233,248,0,240,27,252,0,240,31,249,2,40,4,70,49,208,3,40,79,240,1,1,64,208,136,66,8,209,0,144,33,70,33,72,5,34,79,244,160,35,0,240,77,248,54,224,0,145,29,72,5,34,79,244,160,35,0,240,69,248,27,72,0,240,215,248,208,241,1,4,56,191,0,36,39,224,1,33,0,145,21,72,10,70,79,244,128,19,0,240,53,248,0,240,164,251,8,177,0,240,167,251,0,240,235,253,1,53,5,45,237,221,0,44,235,209,13,72,0,240,187,248,24,177,11,72,0,240,53,249,13,224,1,33,0,145,7,72,5,34,79,244,160,35,0,240,25,248,0,240,68,249,2,224,12,70,0,37,229,231,0,32,3,176,48,189,0,191,0,8,1,64,0,32,0,8,1,35,3,250,1,241,210,241,1,2,56,191,0,34,19,1,153,64,1,97,112,71,45,233,240,71,157,248,32,160,20,70,202,241,1,7,255,178,58,70,128,70,137,70,30,70,255,247,231,255,180,177,53,70,21,177,0,191,1,61,251,231,64,70,73,70,82,70,255,247,220,255,53,70,21,177,0,191,1,61,251,231,64,70,73,70,58,70,1,60,255,247,209,255,228,178,231,231,189,232,240,135,0,0,13,75,14,73,26,104,66,240,1,2,26,96,12,74,16,104,1,64,17,96,25,104,33,240,132,113,33,244,128,49,25,96,25,104,33,244,128,33,25,96,19,104,35,244,254,3,19,96,4,75,0,34,26,96,112,71,0,16,2,64,0,0,255,248,4,16,2,64,8,16,2,64,21,75,26,104,66,240,1,18,26,96,26,104,18,72,146,3,251,213,18,74,18,33,17,96,162,246,252,114,17,104,65,244,232,17,65,244,128,97,17,96,1,104,65,240,128,113,1,96,25,104,17,240,64,127,251,208,17,104,65,240,2,1,17,96,17,104,9,7,252,213,154,105,66,244,254,114,154,97,218,105,66,244,0,2,218,97,112,71,0,16,2,64,0,32,2,64,3,75,26,104,34,240,240,2,66,240,16,2,26,96,112,71,0,8,1,64,5,75,26,104,209,7,3,212,26,104,66,240,1,2,26,96,26,104,146,7,252,213,112,71,0,16,2,64,3,104,3,72,24,64,176,241,0,83,88,66,88,65,112,71,0,0,254,47,4,74,8,181,67,104,16,96,2,104,130,243,8,136,152,71,8,189,0,191,8,237,0,224,8,75,218,105,66,240,192,82,218,97,163,245,208,51,26,104,66,244,128,114,26,96,4,74,16,133,26,104,34,244,128,114,26,96,112,71,0,16,2,64,0,108,0,64,56,181,15,77,235,105,67,240,192,83,235,97,13,75,28,141,164,178,0,240,223,250,64,177,164,245,132,67,76,59,155,178,6,43,2,216,8,74,212,92,1,224,60,177,0,36,0,32,255,247,208,255,235,105,35,240,192,83,235,97,32,70,56,189,0,16,2,64,0,108,0,64,32,29,0,8,66,9,1,35,0,240,31,0,3,250,0,240,1,75,67,248,34,0,112,71,0,225,0,224,66,9,1,35,0,240,31,0,3,250,0,240,2,75,32,50,67,248,34,0,112,71,0,191,0,225,0,224,7,75,79,240,255,50,195,248,128,32,195,248,132,32,195,248,128,33,195,248,132,33,4,34,67,248,240,44,112,71,0,191,0,225,0,224,16,181,11,75,128,34,26,96,4,70,255,247,27,254,0,240,17,251,255,247,227,255,255,247,239,253,68,242,82,32,255,247,135,255,255,247,3,255,32,70,189,232,16,64,255,247,116,191,16,32,2,64,2,74,3,75,218,96,0,191,253,231,0,191,4,0,250,5,0,237,0,224,10,75,16,181,26,104,2,34,26,96,9,74,17,104,20,70,17,240,1,15,249,209,144,96,66,34,26,96,34,104,18,240,1,1,251,209,25,96,1,32,16,189,0,191,16,32,2,64,12,32,2,64,55,181,139,178,0,147,11,12,1,147,14,75,1,34,28,104,26,96,13,74,21,104,237,7,251,212,1,157,173,178,69,128,21,104,237,7,252,212,0,157,173,178,5,128,21,104,237,7,252,212,36,240,1,2,26,96,0,104,67,26,88,66,88,65,3,176,48,189,16,32,2,64,12,32,2,64,1,75,128,34,26,96,112,71,16,32,2,64,3,75,4,74,26,96,2,241,136,50,26,96,112,71,0,191,4,32,2,64,35,1,103,69,7,40,200,191,8,56,15,35,128,0,3,250,0,240,192,67,112,71,0,0,2,75,24,136,0,245,0,48,128,2,112,71,224,247,255,31,4,75,27,136,129,43,52,191,79,244,128,96,79,244,0,96,112,71,0,191,224,247,255,31,13,74,0,35,2,33,19,112,83,112,147,112,211,112,17,113,83,113,10,74,10,73,19,96,10,74,19,128,10,74,17,96,10,74,1,245,136,65,17,96,9,74,3,33,19,112,9,74,17,112,9,74,19,112,112,71,41,13,0,32,36,13,0,32,0,12,0,32,34,13,0,32,196,2,0,32,192,2,0,32,40,13,0,32,208,2,0,32,47,13,0,32,8,181,14,75,14,72,25,121,0,34,201,178,1,41,2,96,8,209,2,33,25,113,26,112,255,247,30,255,189,232,8,64,255,247,42,189,17,240,253,15,6,208,2,33,25,113,26,112,189,232,8,64,255,247,60,191,8,189,0,191,41,13,0,32,36,13,0,32,32,185,3,75,1,34,27,104,26,130,112,71,1,72,112,71,16,5,0,32,45,13,0,32,32,185,3,75,6,34,27,104,26,130,112,71,1,72,112,71,16,5,0,32,41,13,0,32,6,75,27,104,48,185,218,136,89,138,81,26,25,130,4,75,26,128,112,71,91,138,3,72,24,68,112,71,16,5,0,32,34,13,0,32,32,5,0,32,8,75,48,185,27,104,8,74,17,136,90,138,138,26,26,130,112,71,6,73,6,74,27,104,18,104,8,104,91,138,16,68,24,68,112,71,16,5,0,32,34,13,0,32,196,2,0,32,36,13,0,32,112,181,15,78,0,36,53,104,5,241,0,101,5,245,0,85,40,70,255,247,239,254,11,75,26,136,146,178,148,66,6,218,9,75,40,25,225,88,255,247,255,254,4,52,243,231,49,104,26,136,146,178,10,68,50,96,0,34,26,128,112,189,0,191,36,13,0,32,34,13,0,32,32,5,0,32,45,233,240,65,121,73,122,76,1,32,8,112,35,121,0,34,219,178,2,43,34,112,75,209,8,112,118,73,9,104,72,120,1,40,27,209,203,136,0,43,0,240,182,128,114,75,26,96,10,123,3,35,2,42,35,113,13,209,112,74,19,112,112,74,112,75,26,96,255,247,0,254,255,247,244,254,68,242,77,32,255,247,30,254,195,224,10,34,34,113,191,224,2,40,33,209,9,35,35,113,202,136,104,75,26,128,24,136,103,74,128,178,16,128,26,136,75,136,146,178,90,67,95,75,26,96,11,123,1,43,3,208,2,43,9,209,93,74,0,224,96,74,93,75,26,96,255,247,229,254,95,75,24,96,160,224,10,35,35,113,3,35,155,224,6,40,60,208,3,40,25,208,5,40,60,224,3,43,11,209,79,74,18,104,82,120,3,42,4,209,5,35,35,113,255,247,119,255,138,224,5,42,46,224,4,43,9,209,81,73,8,120,2,40,3,209,3,35,98,112,11,112,5,35,35,113,124,224,5,43,20,209,66,75,26,104,83,120,1,43,8,209,211,136,11,177,3,35,242,231,6,35,35,113,255,247,147,254,108,224,6,43,77,208,3,43,75,208,5,43,98,209,72,224,6,43,11,209,55,73,9,104,73,120,3,41,3,209,8,35,35,113,34,112,90,224,5,41,84,209,216,231,7,43,246,208,8,43,212,208,9,43,60,209,46,75,26,104,83,120,2,43,45,209,208,136,56,179,47,73,82,136,11,136,45,77,155,178,83,67,40,74,47,78,19,96,47,104,210,248,0,128,177,248,0,192,71,68,51,104,31,250,140,252,103,68,159,66,38,75,3,216,10,136,146,178,26,128,25,224,54,104,45,104,17,104,114,27,82,26,146,178,26,128,26,136,146,178,130,66,8,211,0,34,26,128,5,224,10,35,35,113,9,35,29,224,6,43,1,209,2,35,155,231,3,43,1,208,5,43,18,209,9,35,149,231,10,43,14,209,14,75,27,104,91,120,3,43,1,209,10,35,140,231,5,43,251,208,4,43,3,209,2,35,35,113,0,35,2,224,10,35,35,113,15,35,35,112,32,120,208,241,1,0,56,191,0,32,189,232,240,129,47,13,0,32,41,13,0,32,16,5,0,32,36,13,0,32,40,13,0,32,0,32,0,8,196,2,0,32,32,13,0,32,34,13,0,32,0,80,0,8,192,2,0,32,208,2,0,32,1,75,24,120,112,71,0,191,47,13,0,32,0,191,253,231,114,182,2,75,0,34,26,96,112,71,0,191,16,224,0,224,13,75,26,136,146,6,20,212,12,75,74,246,170,34,26,96,79,240,128,66,19,138,217,7,242,213,19,138,35,240,1,3,27,4,27,12,19,130,6,75,218,104,130,240,2,2,218,96,230,231,152,136,192,178,112,71,0,68,0,64,0,48,0,64,0,8,1,64,2,75,26,136,18,6,251,213,152,128,112,71,0,72,0,64,5,75,6,74,89,106,17,96,89,106,65,240,128,113,89,98,16,104,192,243,0,112,112,71,0,16,2,64,216,2,0,32,46,75,16,181,218,105,46,73,66,244,0,50,218,97,218,105,66,242,12,0,66,244,128,34,218,97,218,105,64,242,113,36,66,240,1,2,218,97,154,105,66,240,4,2,154,97,154,105,66,240,8,2,154,97,154,105,66,240,1,2,154,97,163,245,130,51,90,104,34,244,112,98,66,244,16,98,90,96,0,34,12,129,136,129,10,130,138,130,161,248,8,68,161,248,12,4,161,248,16,36,161,248,20,36,79,240,128,65,138,132,71,34,10,133,79,246,255,114,138,133,1,34,10,128,17,74,241,33,17,97,16,104,16,73,0,244,127,64,1,67,17,96,162,245,0,98,81,104,33,240,224,97,65,240,128,97,81,96,26,104,34,244,112,66,34,240,240,2,66,244,0,82,66,240,32,2,26,96,8,34,90,97,2,34,26,97,16,189,0,16,2,64,0,68,0,64,0,8,1,64,40,0,136,136,4,75,152,104,0,240,241,0,176,241,240,3,88,66,88,65,112,71,0,191,0,8,1,64,12,74,13,73,0,35,147,129,19,129,139,129,11,129,16,136,144,136,19,128,11,128,2,245,230,50,209,105,33,244,0,49,209,97,209,105,33,244,128,33,209,97,79,240,128,66,19,128,112,71,0,191,0,68,0,64,0,72,0,64,8,181,255,247,51,255,32,40,3,208,4,75,1,34,26,112,8,189,20,32,189,232,8,64,255,247,74,191,213,2,0,32,16,181,4,70,1,60,255,247,33,255,20,240,255,4,249,209,189,232,16,64,255,247,228,191,158,75,45,233,247,79,79,240,128,82,195,248,128,32,156,77,156,75,0,38,1,34,128,70,26,112,46,112,196,178,55,70,152,74,19,120,0,43,46,208,151,75,26,136,145,6,20,213,155,136,79,246,255,114,155,178,147,66,14,208,48,44,219,178,12,209,48,43,10,208,32,43,3,209,142,75,0,34,26,112,25,224,184,241,0,15,1,208,12,225,35,70,139,74,74,246,170,33,17,96,79,240,128,65,10,138,210,7,45,213,10,138,34,240,1,2,18,4,18,12,10,130,133,74,209,104,129,240,2,1,209,96,33,224,255,247,205,254,255,247,207,252,255,247,209,254,48,40,10,191,42,120,0,34,1,50,42,112,42,120,5,42,20,216,65,40,38,209,255,247,196,254,130,70,255,247,139,255,186,241,130,15,24,209,7,32,255,247,221,254,113,74,19,120,0,43,0,240,210,128,35,70,28,70,168,231,113,74,46,177,8,33,81,97,2,33,17,97,0,38,2,224,10,33,17,97,1,38,0,34,42,112,220,231,186,241,129,15,12,191,4,32,3,32,225,231,66,40,1,209,20,32,2,224,69,40,3,209,5,32,255,247,112,255,217,231,85,40,9,209,255,247,145,254,7,70,255,247,142,254,71,234,0,32,135,178,127,0,161,224,86,40,4,209,4,32,255,247,94,255,0,32,196,231,100,40,95,209,255,247,126,254,0,2,31,250,128,250,255,247,121,254,74,234,0,0,31,250,128,249,255,247,115,254,79,240,0,10,255,247,111,254,80,74,2,248,10,0,10,241,1,10,31,250,138,241,137,69,244,209,9,241,255,49,137,178,1,49,17,68,10,70,193,235,9,11,147,68,31,250,139,251,27,240,3,15,3,208,255,32,2,248,1,11,243,231,67,75,7,241,0,106,154,69,103,216,255,247,23,255,65,75,154,69,142,217,202,243,9,3,19,185,80,70,255,247,250,251,83,70,223,248,248,160,79,234,155,11,10,241,4,10,187,241,0,15,63,244,126,175,26,248,6,44,26,248,7,12,26,248,8,28,18,4,66,234,0,34,10,67,26,248,5,28,24,70,66,234,1,97,1,147,255,247,247,251,1,155,11,241,255,59,4,51,31,250,139,251,224,231,116,40,28,209,255,247,28,254,1,144,255,247,25,254,131,70,255,247,22,254,255,247,222,254,1,155,7,241,0,106,75,234,3,43,11,241,255,59,10,241,1,2,31,250,139,251,147,68,26,248,1,11,255,247,38,254,218,69,249,209,69,231,117,40,9,209,255,247,199,254,30,32,255,247,28,254,85,32,255,247,25,254,170,32,55,231,81,40,11,209,255,247,187,254,20,72,255,247,2,251,0,40,63,244,48,175,17,72,255,247,122,251,43,231,255,247,175,254,40,231,16,32,255,247,3,254,41,231,3,176,189,232,240,143,0,191,0,225,0,224,212,2,0,32,213,2,0,32,0,68,0,64,0,48,0,64,0,8,1,64,0,12,1,64,224,2,0,32,255,255,1,8,255,31,0,8,0,32,0,8,228,2,0,32,8,181,11,75,26,136,146,6,74,191,152,136,79,246,255,112,128,178,192,178,48,40,1,209,255,247,156,254,255,247,84,254,32,177,0,32,189,232,8,64,255,247,148,190,8,189,0,191,0,68,0,64,128,0,0,241,128,64,0,245,184,64,3,104,202,6,35,244,224,67,35,240,64,3,155,178,72,191,131,240,16,3,138,6,72,191,131,240,32,3,3,96,112,71,128,0,0,241,128,64,0,245,184,64,3,104,35,244,128,67,35,240,112,3,155,178,131,244,64,83,3,96,112,71,128,0,0,241,128,64,0,245,184,64,3,104,35,244,226,67,35,240,112,3,27,4,27,12,3,96,112,71,128,0,0,241,128,64,0,245,184,64,3,104,91,4,6,213,2,104,72,246,143,115,19,64,67,244,128,67,3,96,112,71,128,0,0,241,128,64,0,245,184,64,3,104,91,6,6,213,2,104,72,246,143,115,19,64,67,240,64,3,3,96,112,71,5,75,27,104,155,178,3,235,192,0,0,241,0,80,0,245,64,80,64,0,0,136,112,71,80,92,0,64,4,75,27,104,155,178,3,235,192,0,3,75,3,68,91,0,24,136,112,71,80,92,0,64,4,48,0,32,4,75,27,104,155,178,3,235,192,0,3,75,3,68,91,0,25,96,112,71,80,92,0,64,2,48,0,32,13,75,62,41,27,104,155,178,3,235,192,0,11,75,3,68,79,234,67,2,9,217,75,9,200,6,4,191,3,241,255,51,155,178,155,2,67,244,0,67,4,224,75,8,201,7,72,191,1,51,155,2,19,96,112,71,80,92,0,64,6,48,0,32,112,181,76,74,76,75,17,104,136,178,12,4,24,128,64,241,144,128,71,246,255,113,17,96,26,136,72,76,2,240,15,2,34,112,0,42,95,209,70,76,70,77,34,104,70,78,2,244,64,82,42,128,34,104,2,240,48,2,50,128,34,104,34,244,128,66,34,240,112,2,146,178,130,244,0,82,34,96,34,104,34,244,224,66,34,240,64,2,146,178,130,240,32,2,34,96,27,136,216,6,2,213,35,104,25,6,7,213,34,104,72,246,15,115,19,64,35,96,0,240,97,252,18,224,26,5,7,213,34,104,64,246,143,115,19,64,35,96,0,240,105,250,8,224,24,4,182,213,34,104,64,246,143,115,19,64,35,96,0,240,205,251,35,104,42,136,35,244,128,67,35,240,112,3,155,178,209,4,72,191,131,244,128,83,149,4,33,74,72,191,131,244,0,83,19,96,19,104,49,136,35,244,224,67,35,240,64,3,155,178,204,6,72,191,131,240,16,3,136,6,72,191,131,240,32,3,19,96,112,189,147,0,3,241,128,67,3,245,184,67,29,104,41,4,9,213,24,104,64,246,143,113,1,64,25,96,18,75,1,58,83,248,34,48,152,71,43,6,127,245,121,175,33,120,72,246,15,114,139,0,3,241,128,67,3,245,184,67,24,104,1,57,2,64,26,96,9,75,83,248,33,48,152,71,103,231,112,189,68,92,0,64,204,2,0,32,236,4,0,32,0,92,0,64,224,4,0,32,226,4,0,32,80,0,0,32,52,0,0,32,8,181,7,74,7,75,8,73,19,96,2,34,26,114,7,75,7,74,19,96,7,74,27,104,17,96,152,71,8,189,0,191,16,5,0,32,240,4,0,32,108,0,0,32,0,0,0,32,232,4,0,32,12,5,0,32,16,181,6,76,24,185,35,104,1,34,26,130,16,189,4,75,27,104,27,104,152,71,32,104,10,48,16,189,16,5,0,32,12,5,0,32,16,181,6,76,24,185,35,104,1,34,26,130,16,189,4,75,27,104,155,104,152,71,32,104,12,48,16,189,16,5,0,32,12,5,0,32,16,181,32,75,24,185,27,104,2,34,26,130,16,189,30,74,25,104,0,32,16,128,12,120,19,70,20,240,127,4,13,209,74,122,145,6,68,191,2,33,25,112,18,240,64,15,26,120,20,191,34,240,1,2,66,240,1,2,20,224,1,44,31,208,2,44,30,209,9,121,1,240,15,2,146,0,2,241,128,66,2,245,184,66,17,240,128,15,18,104,6,208,2,240,48,2,16,42,7,209,1,34,26,112,4,224,2,244,64,82,178,245,128,95,246,231,5,75,27,104,27,105,152,71,2,72,16,189,16,70,16,189,16,5,0,32,22,5,0,32,12,5,0,32,35,74,45,233,248,67,20,104,144,70,35,138,38,122,33,79,163,185,4,46,18,209,32,73,10,120,1,42,10,209,31,74,16,104,31,74,128,178,2,68,82,0,19,96,48,34,58,128,11,112,39,224,16,35,59,128,7,38,35,224,165,138,171,66,140,191,2,38,4,38,157,66,40,191,29,70,40,70,163,105,152,71,129,70,0,32,255,247,87,254,42,70,1,70,72,70,0,240,104,251,41,70,0,32,255,247,106,254,35,138,79,244,64,82,91,27,35,130,99,138,29,68,48,35,59,128,9,75,101,130,26,128,216,248,0,48,30,114,189,232,248,131,0,191,16,5,0,32,226,4,0,32,48,13,0,32,80,92,0,64,2,48,0,32,224,4,0,32,16,181,10,75,10,73,27,104,73,120,154,120,145,66,10,211,217,120,65,185,156,136,52,185,154,114,6,75,27,104,91,104,152,71,32,70,16,189,2,32,16,189,0,191,16,5,0,32,144,0,0,32,12,5,0,32,56,181,14,74,14,76,18,104,35,104,146,105,24,121,153,120,144,71,35,104,154,122,122,177,112,185,90,121,98,185,221,120,85,185,8,75,27,104,219,104,152,71,35,104,40,70,26,121,218,114,154,120,26,115,56,189,2,32,56,189,232,4,0,32,16,5,0,32,12,5,0,32,56,181,47,75,27,104,24,120,16,240,127,0,4,209,90,122,34,240,32,2,90,114,56,189,2,40,78,209,90,136,0,42,76,209,90,121,0,42,73,209,26,121,38,77,34,240,128,0,132,0,4,241,128,65,1,245,184,65,9,104,45,120,18,240,128,15,20,191,1,240,48,1,1,244,64,81,168,66,52,210,0,41,50,208,155,122,131,179,4,241,128,68,4,245,184,68,18,6,35,104,12,213,3,240,48,3,16,43,31,209,196,178,32,70,255,247,165,253,32,70,48,33,255,247,95,253,22,224,3,244,64,83,179,245,128,95,17,209,40,185,14,75,147,248,48,16,255,247,207,253,1,224,255,247,130,253,35,104,35,244,128,67,35,240,112,3,155,178,131,244,64,83,35,96,7,75,27,104,91,105,152,71,0,32,56,189,2,32,56,189,0,191,16,5,0,32,144,0,0,32,0,0,0,32,12,5,0,32,56,181,29,75,29,77,25,104,45,120,10,121,34,240,128,4,163,0,3,241,128,64,0,245,184,64,0,104,18,240,128,15,20,191,0,240,48,0,0,244,64,80,172,66,34,210,76,136,4,187,248,177,137,122,233,177,3,241,128,67,3,245,184,67,18,240,128,15,26,104,7,208,34,244,224,66,34,240,64,2,146,178,130,240,16,2,6,224,34,244,128,66,34,240,112,2,146,178,130,244,128,82,26,96,5,75,27,104,155,105,152,71,0,32,56,189,2,32,56,189,16,5,0,32,144,0,0,32,12,5,0,32,8,181,6,75,27,104,90,122,66,240,32,2,90,114,4,75,27,104,219,105,152,71,0,32,8,189,0,191,16,5,0,32,12,5,0,32,5,75,26,104,83,138,24,185,137,136,203,26,19,130,112,71,8,104,24,68,112,71,0,191,16,5,0,32,8,181,11,75,0,32,147,248,48,16,255,247,73,253,9,75,27,104,24,122,8,40,6,209,7,75,79,244,128,82,26,128,6,75,16,34,26,128,176,241,9,3,88,66,88,65,8,189,0,0,0,32,16,5,0,32,224,4,0,32,226,4,0,32,115,181,150,78,150,75,50,104,150,77,146,178,19,68,91,0,26,104,43,104,25,122,9,41,15,208,146,178,82,0,2,241,128,66,2,245,192,66,17,120,25,112,81,120,89,112,145,136,89,128,17,137,153,128,146,137,218,128,1,34,26,114,218,136,92,120,0,42,97,209,26,120,18,240,127,2,58,209,9,44,2,209,255,247,171,254,68,224,5,44,15,209,147,249,2,32,0,42,1,218,8,35,77,224,218,120,0,42,250,209,154,136,0,42,247,209,155,122,0,43,55,208,243,231,3,44,19,209,154,120,1,42,7,208,120,75,32,70,27,104,91,105,152,71,3,40,40,209,53,224,154,136,0,42,244,209,91,122,152,6,241,213,255,247,109,255,28,224,1,44,236,209,154,120,1,42,233,209,154,136,0,42,230,209,91,122,153,6,227,213,255,247,181,254,14,224,1,42,4,209,11,44,220,209,255,247,138,254,7,224,2,42,215,209,1,44,241,208,3,44,211,209,255,247,13,255,16,177,207,231,0,40,188,209,50,104,95,75,146,178,19,68,91,0,0,34,26,96,93,75,48,34,26,128,6,35,0,224,9,35,42,104,19,114,212,224,6,44,24,209,26,120,82,6,124,209,218,120,84,75,1,42,2,209,27,104,219,105,108,224,2,42,2,209,27,104,27,106,103,224,3,42,2,209,27,104,91,106,98,224,33,42,105,209,27,104,155,106,93,224,0,44,60,209,89,136,0,41,97,209,90,104,34,240,255,2,178,245,0,63,91,209,26,120,18,240,127,2,4,209,155,136,0,43,0,240,171,128,82,224,1,42,12,209,62,74,24,121,18,104,146,105,144,71,0,40,73,209,43,104,155,122,0,43,64,240,156,128,67,224,2,42,65,209,27,121,57,72,3,240,15,1,138,0,2,241,128,66,2,245,184,66,18,104,0,120,19,240,128,15,20,191,2,240,48,2,2,244,64,82,129,66,45,210,19,240,112,15,42,209,0,42,127,209,39,224,8,44,3,209,27,120,91,6,123,208,33,224,10,44,31,209,26,120,2,240,127,2,1,42,26,209,154,122,194,177,89,136,177,185,90,104,34,240,255,2,178,245,128,63,16,209,30,74,24,121,18,104,146,105,144,71,0,40,100,208,8,224,59,177,42,104,0,36,84,130,147,97,32,70,152,71,32,70,10,224,22,75,26,104,43,104,18,105,88,120,144,71,3,40,2,209,17,75,27,104,5,224,43,104,79,246,255,113,26,138,138,66,1,209,9,34,3,224,2,40,0,208,18,185,8,34,26,114,57,224,147,249,0,16,0,41,47,218,217,136,1,145,1,152,130,66,5,72,17,217,1,154,26,130,31,224,0,191,80,92,0,64,4,48,0,32,16,5,0,32,232,4,0,32,2,48,0,32,226,4,0,32,144,0,0,32,138,66,14,210,1,104,145,248,48,16,138,66,1,210,0,33,5,224,146,251,241,244,1,251,20,34,18,185,1,33,12,74,17,112,2,104,146,248,48,32,154,130,255,247,47,253,5,224,3,34,26,114,7,75,79,244,64,82,26,128,255,247,132,254,2,176,112,189,4,75,158,231,4,75,156,231,4,75,154,231,48,13,0,32,224,4,0,32,9,21,0,8,193,20,0,8,229,20,0,8,248,181,43,77,44,104,35,122,3,43,1,208,5,43,65,209,163,105,34,138,171,177,162,177,166,138,150,66,40,191,22,70,48,70,152,71,35,138,7,70,155,27,35,130,99,138,0,32,51,68,99,130,255,247,138,251,50,70,1,70,56,70,0,240,165,248,35,138,83,177,27,75,0,32,79,244,64,82,1,70,26,128,255,247,137,251,24,75,48,34,26,128,35,138,162,138,154,66,2,216,43,104,3,34,2,224,27,177,43,104,5,34,26,114,12,224,42,104,6,33,17,114,16,74,17,104,16,74,137,178,10,68,82,0,19,96,11,75,48,34,26,128,43,104,27,122,6,224,7,43,3,209,10,75,27,104,219,104,152,71,8,35,42,104,19,114,189,232,248,64,255,247,27,190,0,191,16,5,0,32,224,4,0,32,226,4,0,32,80,92,0,64,2,48,0,32,232,4,0,32,48,181,11,75,28,120,0,35,163,66,12,210,3,241,128,82,2,245,184,82,145,0,13,104,72,246,143,114,42,64,26,67,10,96,1,51,240,231,3,75,64,240,128,0,24,96,48,189,144,0,0,32,76,92,0,64,16,181,19,76,35,104,26,122,2,42,1,208,4,42,4,209,255,247,138,252,35,104,27,122,19,224,6,42,16,209,90,120,5,42,9,209,26,120,82,6,6,209,152,120,255,247,204,255,8,75,27,104,27,106,152,71,7,75,27,104,155,104,152,71,8,35,34,104,19,114,189,232,16,64,255,247,203,189,0,191,16,5,0,32,12,5,0,32,232,4,0,32,48,181,1,241,0,81,1,50,1,245,64,81,82,16,73,0,0,35,147,66,0,241,2,0,9,208,16,248,1,92,16,248,2,76,68,234,5,36,33,248,35,64,1,51,241,231,48,189,16,181,1,241,0,81,1,50,1,245,64,81,82,16,73,0,0,35,147,66,5,208,81,248,35,64,32,248,19,64,1,51,247,231,16,189,1,2,0,0,0,0,3,0,121,4,0,8,129,1,0,8,63,1,0,8,65,1,0,8,41,2,0,8,205,2,0,8,67,1,0,8,137,2,0,8,149,2,0,8,161,2,0,8,193,2,0,8,0,0,0,0,64,0,0,0,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,61,1,0,8,77,1,0,8,81,1,0,8,105,1,0,8,107,1,0,8,109,1,0,8,111,1,0,8,113,1,0,8,115,1,0,8,117,1,0,8,1,1,0,0,232,0,0,32,4,0,0,0,50,1,0,32,18,0,0,0,76,1,0,32,20,0,0,0,25,1,0,32,16,0,0,0,96,1,0,32,128,0,0,0,224,1,0,32,108,0,0,0,76,2,0,32,108,0,0,0,18,1,0,1,0,0,0,64,175,30,3,0,1,2,1,2,3,1,0,0,41,1,0,32,9,0,0,0,4,3,9,4,9,2,45,0,1,1,0,128,50,9,4,0,0,0,254,1,2,4,9,4,0,1,0,254,1,2,5,9,4,0,2,0,254,1,2,6,9,33,3,255,0,0,8,16,1,16,3,76,0,76,0,77,0,32,0,48,0,48,0,51,0,9,33,3,255,0,0,8,16,1,18,3,76,0,101,0,97,0,102,0,76,0,97,0,98,0,115,0,204,0,0,32,18,0,0,0,20,3,77,0,97,0,112,0,108,0,101,0,32,0,48,0,48,0,51,0,128,3,83,0,84,0,77,0,51,0,50,0,100,0,117,0,105,0,110,0,111,0,32,0,98,0,111,0,111,0,116,0,108,0,111,0,97,0,100,0,101,0,114,0,32,0,118,0,49,0,46,0,48,0,32,0,32,0,69,0,82,0,82,0,79,0,82,0,46,0,32,0,85,0,112,0,108,0,111,0,97,0,100,0,32,0,116,0,111,0,32,0,82,0,65,0,77,0,32,0,110,0,111,0,116,0,32,0,115,0,117,0,112,0,112,0,111,0,114,0,116,0,101,0,100,0,46,0,108,3,83,0,84,0,77,0,51,0,50,0,100,0,117,0,105,0,110,0,111,0,32,0,98,0,111,0,111,0,116,0,108,0,111,0,97,0,100,0,101,0,114,0,32,0,118,0,49,0,46,0,48,0,32,0,32,0,85,0,112,0,108,0,111,0,97,0,100,0,32,0,116,0,111,0,32,0,70,0,108,0,97,0,115,0,104,0,32,0,48,0,120,0,56,0,48,0,48,0,53,0,48,0,48,0,48,0,108,3,83,0,84,0,77,0,51,0,50,0,100,0,117,0,105,0,110,0,111,0,32,0,98,0,111,0,111,0,116,0,108,0,111,0,97,0,100,0,101,0,114,0,32,0,118,0,49,0,46,0,48,0,32,0,32,0,85,0,112,0,108,0,111,0,97,0,100,0,32,0,116,0,111,0,32,0,70,0,108,0,97,0,115,0,104,0,32,0,48,0,120,0,56,0,48,0,48,0,50,0,48,0,48,0,48,0,236,0,0,32,45,0,0,0,0,80,0,32,0,12,0,32,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255 };

 /* Initializes the GPIO pins for inputs, outputs, and USARTs */
static void GPIO_Init()
{
	// Structure for configuring GPIO pins
	GPIO_InitTypeDef GPIO_InitStruct;

	// Enable the clocks
	__HAL_RCC_GPIOA_CLK_ENABLE();
	__HAL_RCC_GPIOB_CLK_ENABLE();

	// Configure PA1 and PA2 as outputs (red LED is PA1; green LED is PA2)
	GPIO_InitStruct.Pin = GPIO_PIN_1 | GPIO_PIN_2;
	GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
	GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
	HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);
}

/*
 * Handle for Timer 2
*/
static TIM_HandleTypeDef hTIM2;

/*
 * Initializes Timer 2
  * Frequency is 30Hz: 72000000 / ((239+1) * (9999+1)) = 30
 */
static void Timer_Init()
{
	__HAL_RCC_TIM2_CLK_ENABLE();	// Enable the clock

	hTIM2.Instance = TIM2;
	hTIM2.Init.Prescaler = 9999;
	hTIM2.Init.CounterMode = TIM_COUNTERMODE_UP;
	hTIM2.Init.Period = 239;
	hTIM2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
	hTIM2.Init.RepetitionCounter = 0;
	HAL_TIM_Base_Init(&hTIM2);

}

/*
 * Timer 2 interrupt handler override
 * Update interrupts are used to flash the red LED when the bootloader is active.
 */
extern "C" void TIM2_IRQHandler()
{
	HAL_TIM_IRQHandler(&hTIM2);
}

/*
 * Timer 2 update interrupt callback handler
 */
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef* htim)
{
	// Toggle the LED pin
	HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_1);
}

/*
 * Writes the bootloader data to the module's flash memory
*/
void writeBootloader() {

	uint32_t memAddress;

	for (int i = 0; i < 8192; i += 2)
	{
		memAddress = (FLASH_START + WRITE_OFFSET + i);
		// Check if this is the start of the page; if so we'll erase it
		if (((uint32_t)memAddress & PAGE_END) == 0)
		{
			// Clear the flash flags
			__HAL_FLASH_CLEAR_FLAG(FLASH_FLAG_EOP | FLASH_FLAG_WRPERR | FLASH_FLAG_PGERR);

			// Structure for erasing flash pages
			FLASH_EraseInitTypeDef EraseInitStruct;
			uint32_t SectorError = 0;

			// Configure the erase
			EraseInitStruct.TypeErase = FLASH_TYPEERASE_PAGES;
			EraseInitStruct.PageAddress = (uint32_t)memAddress;
			EraseInitStruct.NbPages = 1;

			// Erase the page
			HAL_FLASHEx_Erase(&EraseInitStruct, &SectorError);
		}

		// Get two bytes of data
		uint16_t data = bootloaderData[i + 1] << 8 | bootloaderData[i];

		// Write the data
		HAL_FLASH_Program(FLASH_TYPEPROGRAM_HALFWORD, (uint32_t)memAddress, data);
	}
}

void selfTerminate() 
{
	uint32_t memAddress = APPLICATION_START;

	// Clear the flash flags
	__HAL_FLASH_CLEAR_FLAG(FLASH_FLAG_EOP | FLASH_FLAG_WRPERR | FLASH_FLAG_PGERR);

	// Structure for erasing flash pages
	FLASH_EraseInitTypeDef EraseInitStruct;
	uint32_t SectorError = 0;

	// Configure the erase
	EraseInitStruct.TypeErase = FLASH_TYPEERASE_PAGES;
	EraseInitStruct.PageAddress = (uint32_t)memAddress;
	EraseInitStruct.NbPages = 1;

	// Erase the page
	HAL_FLASHEx_Erase(&EraseInitStruct, &SectorError);

}

// The setup() function runs once each time the micro-controller starts
void setup()
{
	// Initialize the STM32 HAL
	HAL_Init();

	// Initialize the timer
	Timer_Init();

	// Initialize the GPIO pins
	GPIO_Init();

	// Initialize the USARTs
	//Serial_Init();

	// Turn the LED on
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_PIN_SET);

	HAL_Delay(2000);
}

bool bootloaderUpgradeDone = false;

// Add the main program code into the continuous loop() function
void loop()
{
	while (!bootloaderUpgradeDone) {
		// Check that we can read the new bootloader

		// Start blinking the LED really fast so the user knows we're doing scary stuff
		HAL_TIM_Base_Start_IT(&hTIM2);

		// Unlock the flash
		HAL_FLASH_Unlock();

		// Rewrite the bootloader
		HAL_Delay(2000);

		writeBootloader();
		
		// Delete ourself so we don't run again
		selfTerminate();

		// Lock the flash
		HAL_FLASH_Lock();

		// Stop blinking the LED
		HAL_TIM_Base_Stop(&hTIM2);

		// Turn the LED on to show we finished writing
		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_PIN_SET);

		// 1s delay
		HAL_Delay(1000);

		// Turn the LED off to show we're done
		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_PIN_RESET);

		// Done
		bootloaderUpgradeDone = true;
	}

	HAL_Delay(50);
}
